<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kemaskini Rekod - {{ record.sumber }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="card shadow-sm mx-auto" style="max-width: 600px;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">✏️ Kemaskini Rekod {{ record.sumber }}</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    <input type="hidden" name="sumber" value="{{ record.sumber }}">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tarikh</label>
                        <input type="date" name="tarikh" class="form-control" value="{{ record.tarikh }}" required>
                    </div>
                    
                    <div class="mb-3">
                        {% if record.sumber == 'Petros' %}
                            <label class="form-label fw-bold">Net Profit (Auto-Calc)</label>
                            <input type="number" step="0.01" class="form-control bg-light" value="{{ record.kutipan_yuran }}" readonly>
                            <div class="form-text text-primary">This value is calculated automatically from Volume - Operational Costs.</div>

                            <!-- Info Formula -->
                            <div class="alert alert-info py-2 mt-2 mb-2 small">
                                <div class="fw-bold text-decoration-underline mb-1">Calculation Formula Reference:</div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>1. Government Commission (Based on Liters):</strong><br>
                                        • 0 - 200,000 L: <strong>RM 0.18</strong><br>
                                        • 200,001 - 500,000 L: <strong>RM 0.17</strong><br>
                                        • > 500,000 L: <strong>RM 0.16</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>2. SEDC License Fee (Threshold 450,000 L):</strong><br>
                                        • < 450k: Mogas (RM 0.015), Diesel (RM 0.01)<br>
                                        • > 450k: Mogas (RM 0.01), Diesel (RM 0.01)
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive mt-3">
                                <table class="table table-bordered table-sm text-center align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 20%;">Type</th>
                                            <th>Sales Volume (Liters)</th>
                                            <th>Sales (RM)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in details %}
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control form-control-sm fw-bold" value="{{ item.jenis_minyak }}" readonly>
                                                <input type="hidden" name="petros_jenis[]" value="{{ item.jenis_minyak }}">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" name="petros_vol[]" class="form-control form-control-sm" value="{{ item.daily_volume }}">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" name="petros_sales[]" class="form-control form-control-sm" value="{{ item.sales_amount }}">
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Input Kos Operasi (Edit) -->
                            <div class="card border-warning mb-3 mt-3">
                                <div class="card-header bg-warning text-dark py-1">
                                    <small class="fw-bold">Update Expenses (Total: RM {{ "{:,.2f}".format(record.kos_pengurusan or 0) }})</small>
                                </div>
                                <div class="card-body p-2">
                                    {% set fixed = record.kos_breakdown.fixed if record.kos_breakdown else {} %}
                                            
                                            <!-- Dynamic Table -->
                                            <table class="table table-bordered table-sm mb-0" id="dynamicCostTable">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th style="width: 150px;">Category</th>
                                                        <th>Description</th>
                                                        <th style="width: 120px;">Amount (RM)</th>
                                                        <th style="width: 50px;"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Render Legacy Fixed Costs as Dynamic Rows -->
                                                    {% for k, v in fixed.items() if v > 0 %}
                                                    <tr>
                                                        <td>
                                                            <select name="other_category[]" class="form-select form-select-sm">
                                                                <option value="A. Monthly Expenses" {% if k in ['salary','epf','socso','eis','levy','pcb'] %}selected{% endif %}>A. Monthly Expenses</option>
                                                                <option value="B. Monthly Services" {% if k in ['retails_system','rentokil','unifi','insurance','safe_guard','tnb','water'] %}selected{% endif %}>B. Monthly Services</option>
                                                                <option value="C. Staff Welfare" {% if k in ['first_aid','osh','typhoid'] %}selected{% endif %}>C. Staff Welfare</option>
                                                                <option value="D. Documents Fees" {% if k in ['ad_fee','pet_license','license_app','trade_license'] %}selected{% endif %}>D. Documents Fees</option>
                                                                <option value="E. Others">E. Others</option>
                                                            </select>
                                                        </td>
                                                        <td><input type="text" name="other_desc[]" class="form-control form-control-sm" value="{{ k|replace('_',' ')|title }}"></td>
                                                        <td><input type="number" step="0.01" name="other_amt[]" class="form-control form-control-sm" value="{{ v }}"></td>
                                                        <td><button type="button" class="btn btn-sm btn-danger py-0" onclick="this.closest('tr').remove()">x</button></td>
                                                    </tr>
                                                    {% endfor %}

                                                    <!-- Render Existing Dynamic Costs -->
                                                    {% for dyn in record.kos_breakdown.dynamic if record.kos_breakdown and record.kos_breakdown.dynamic %}
                                                    <tr>
                                                        <td>
                                                            <select name="other_category[]" class="form-select form-select-sm">
                                                                <option value="A. Monthly Expenses" {% if dyn.category == 'A. Monthly Expenses' or dyn.category == 'Expenses' %}selected{% endif %}>A. Monthly Expenses</option>
                                                                <option value="B. Monthly Services" {% if dyn.category == 'B. Monthly Services' or dyn.category == 'Services' %}selected{% endif %}>B. Monthly Services</option>
                                                                <option value="C. Staff Welfare" {% if dyn.category == 'C. Staff Welfare' or dyn.category == 'Staff Welfare' %}selected{% endif %}>C. Staff Welfare</option>
                                                                <option value="D. Documents Fees" {% if dyn.category == 'D. Documents Fees' or dyn.category == 'Documents Fees' %}selected{% endif %}>D. Documents Fees</option>
                                                                <option value="E. Others" {% if dyn.category == 'E. Others' or dyn.category == 'Other' %}selected{% endif %}>E. Others</option>
                                                            </select>
                                                        </td>
                                                        <td><input type="text" name="other_desc[]" class="form-control form-control-sm" value="{{ dyn.desc }}"></td>
                                                        <td><input type="number" step="0.01" name="other_amt[]" class="form-control form-control-sm" value="{{ dyn.amount }}"></td>
                                                        <td><button type="button" class="btn btn-sm btn-danger py-0" onclick="this.closest('tr').remove()">x</button></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                    <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="addCostRow()">+ Add Expense Row</button>
                                </div>
                            </div>

                        {% else %}
                            <label class="form-label fw-bold">Amaun (RM)</label>
                            <input type="number" step="0.01" name="amaun" class="form-control" value="{{ record.amaun }}" required>
                        {% endif %}
                    </div>
                    
                    {% if record.sumber != 'Petros' %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nota / Keterangan</label>
                        <textarea name="nota" class="form-control" rows="3">{{ record.nota }}</textarea>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        <a href="javascript:history.back()" class="btn btn-secondary">Batal</a>
                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
<script>
    function addCostRow() {
        var table = document.getElementById("dynamicCostTable").getElementsByTagName('tbody')[0];
        var newRow = table.insertRow();
        
        var cell1 = newRow.insertCell(0);
        var cell2 = newRow.insertCell(1);
        var cell3 = newRow.insertCell(2);
        var cell4 = newRow.insertCell(3);
        
        cell1.innerHTML = `
            <select name="other_category[]" class="form-select form-select-sm">
                <option value="A. Monthly Expenses">A. Monthly Expenses</option>
                <option value="B. Monthly Services">B. Monthly Services</option>
                <option value="C. Staff Welfare">C. Staff Welfare</option>
                <option value="D. Documents Fees">D. Documents Fees</option>
                <option value="E. Others">E. Others</option>
            </select>`;
        cell2.innerHTML = '<input type="text" name="other_desc[]" class="form-control form-control-sm" placeholder="Keterangan...">';
        cell3.innerHTML = '<input type="number" step="0.01" name="other_amt[]" class="form-control form-control-sm" placeholder="0.00">';
        cell4.innerHTML = '<button type="button" class="btn btn-sm btn-danger py-0" onclick="this.closest(\'tr\').remove()">x</button>';
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</html>