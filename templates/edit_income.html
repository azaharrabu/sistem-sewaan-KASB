<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kemaskini Rekod - {{ record.sumber }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="card shadow-sm mx-auto" style="max-width: 600px;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">✏️ Kemaskini Rekod {{ record.sumber }}</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    <input type="hidden" name="sumber" value="{{ record.sumber }}">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tarikh</label>
                        <input type="date" name="tarikh" class="form-control" value="{{ record.tarikh }}" required>
                    </div>
                    
                    <div class="mb-3">
                        {% if record.sumber == 'Petros' %}
                            <label class="form-label fw-bold">Net Profit (Auto-Calc)</label>
                            <input type="number" step="0.01" class="form-control bg-light" value="{{ record.kutipan_yuran }}" readonly>
                            <div class="form-text text-primary">This value is calculated automatically from Volume - Operational Costs.</div>

                            <!-- Info Formula -->
                            <div class="alert alert-info py-2 mt-2 mb-2 small">
                                <div class="fw-bold text-decoration-underline mb-1">Calculation Formula Reference:</div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>1. Government Commission (Based on Liters):</strong><br>
                                        • 0 - 200,000 L: <strong>RM 0.18</strong><br>
                                        • 200,001 - 500,000 L: <strong>RM 0.17</strong><br>
                                        • > 500,000 L: <strong>RM 0.16</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>2. SEDC License Fee (Threshold 450,000 L):</strong><br>
                                        • < 450k: Mogas (RM 0.015), Diesel (RM 0.01)<br>
                                        • > 450k: Mogas (RM 0.01), Diesel (RM 0.01)
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive mt-3">
                                <table class="table table-bordered table-sm text-center align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 20%;">Type</th>
                                            <th>Sales Volume (Liters)</th>
                                            <th>Sales (RM)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in details %}
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control form-control-sm fw-bold" value="{{ item.jenis_minyak }}" readonly>
                                                <input type="hidden" name="petros_jenis[]" value="{{ item.jenis_minyak }}">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" name="petros_vol[]" class="form-control form-control-sm" value="{{ item.daily_volume }}">
                                            </td>
                                            <td>
                                                <input type="number" step="0.01" name="petros_sales[]" class="form-control form-control-sm" value="{{ item.sales_amount }}">
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Input Kos Operasi (Edit) -->
                            <div class="card border-warning mb-3 mt-3">
                                <div class="card-header bg-warning text-dark py-1">
                                    <small class="fw-bold">Update Cost Details (Total: RM {{ "{:,.2f}".format(record.kos_pengurusan or 0) }})</small>
                                </div>
                                <div class="card-body p-2">
                                    {% set fixed = record.kos_breakdown.fixed if record.kos_breakdown else {} %}
                                    <div class="row g-3">
                                        <!-- A. Expenses (Monthly) -->
                                        <div class="col-md-6">
                                            <h6 class="small fw-bold text-primary border-bottom pb-1">A. Expenses (Monthly)</h6>
                                            <div class="row g-1">
                                                <div class="col-6"><label class="small">Staff Salary</label><input type="number" step="0.01" name="cost_salary" class="form-control form-control-sm" value="{{ fixed.salary }}"></div>
                                                <div class="col-6"><label class="small">EPF</label><input type="number" step="0.01" name="cost_epf" class="form-control form-control-sm" value="{{ fixed.epf }}"></div>
                                                <div class="col-6"><label class="small">SOCSO</label><input type="number" step="0.01" name="cost_socso" class="form-control form-control-sm" value="{{ fixed.socso }}"></div>
                                                <div class="col-6"><label class="small">EIS</label><input type="number" step="0.01" name="cost_eis" class="form-control form-control-sm" value="{{ fixed.eis }}"></div>
                                                <div class="col-6"><label class="small">Levy</label><input type="number" step="0.01" name="cost_levy" class="form-control form-control-sm" value="{{ fixed.levy }}"></div>
                                                <div class="col-6"><label class="small">Tax Alloc (PCB)</label><input type="number" step="0.01" name="cost_pcb" class="form-control form-control-sm" value="{{ fixed.pcb }}"></div>
                                            </div>
                                        </div>

                                        <!-- B. Services (Monthly) -->
                                        <div class="col-md-6">
                                            <h6 class="small fw-bold text-primary border-bottom pb-1">B. Services (Monthly)</h6>
                                            <div class="row g-1">
                                                <div class="col-6"><label class="small">Retails Auto Sys</label><input type="number" step="0.01" name="cost_retails_system" class="form-control form-control-sm" value="{{ fixed.retails_system }}"></div>
                                                <div class="col-6"><label class="small">Rentokil</label><input type="number" step="0.01" name="cost_rentokil" class="form-control form-control-sm" value="{{ fixed.rentokil }}"></div>
                                                <div class="col-6"><label class="small">Unifi</label><input type="number" step="0.01" name="cost_unifi" class="form-control form-control-sm" value="{{ fixed.unifi }}"></div>
                                                <div class="col-6"><label class="small">Insurance</label><input type="number" step="0.01" name="cost_insurance" class="form-control form-control-sm" value="{{ fixed.insurance }}"></div>
                                                <div class="col-6"><label class="small">Safe Guard</label><input type="number" step="0.01" name="cost_safe_guard" class="form-control form-control-sm" value="{{ fixed.safe_guard }}"></div>
                                                <div class="col-6"><label class="small">TNB Bill</label><input type="number" step="0.01" name="cost_tnb" class="form-control form-control-sm" value="{{ fixed.tnb }}"></div>
                                                <div class="col-6"><label class="small">Water Bill</label><input type="number" step="0.01" name="cost_water" class="form-control form-control-sm" value="{{ fixed.water }}"></div>
                                            </div>
                                        </div>

                                        <!-- D. Documents Fees (Yearly) -->
                                        <div class="col-md-6">
                                            <h6 class="small fw-bold text-primary border-bottom pb-1">D. Documents Fees (Yearly)</h6>
                                            <div class="row g-1">
                                                <div class="col-md-3"><label class="small">Advertisement Fee</label><input type="number" step="0.01" name="cost_ad_fee" class="form-control form-control-sm" value="{{ fixed.ad_fee }}"></div>
                                                <div class="col-md-3"><label class="small">Petroleum License</label><input type="number" step="0.01" name="cost_pet_license" class="form-control form-control-sm" value="{{ fixed.pet_license }}"></div>
                                                <div class="col-md-3"><label class="small">License Application Fee</label><input type="number" step="0.01" name="cost_license_app" class="form-control form-control-sm" value="{{ fixed.license_app }}"></div>
                                                <div class="col-md-3"><label class="small">Trade License</label><input type="number" step="0.01" name="cost_trade_license" class="form-control form-control-sm" value="{{ fixed.trade_license }}"></div>
                                            </div>
                                        </div>

                                        <!-- E. Others -->
                                        <div class="col-md-12">
                                            <h6 class="small fw-bold text-primary border-bottom pb-1">E. Others</h6>
                                            
                                            <!-- Dynamic Table -->
                                            <label class="small fw-bold mt-2">Other Costs (Manual Input)</label>
                                            <table class="table table-bordered table-sm mb-0" id="dynamicCostTable">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th style="width: 150px;">Category</th>
                                                        <th>Description</th>
                                                        <th style="width: 120px;">Amount (RM)</th>
                                                        <th style="width: 50px;"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for dyn in record.kos_breakdown.dynamic if record.kos_breakdown and record.kos_breakdown.dynamic %}
                                                    <tr>
                                                        <td>
                                                            <select name="other_category[]" class="form-select form-select-sm">
                                                                <option value="Expenses" {% if dyn.category == 'Expenses' %}selected{% endif %}>Expenses</option>
                                                                <option value="Services" {% if dyn.category == 'Services' %}selected{% endif %}>Services</option>
                                                                <option value="Staff Welfare" {% if dyn.category == 'Staff Welfare' %}selected{% endif %}>Staff Welfare</option>
                                                                <option value="Documents Fees" {% if dyn.category == 'Documents Fees' %}selected{% endif %}>Documents Fees</option>
                                                                <option value="Other" {% if dyn.category == 'Other' %}selected{% endif %}>Other</option>
                                                            </select>
                                                        </td>
                                                        <td><input type="text" name="other_desc[]" class="form-control form-control-sm" value="{{ dyn.desc }}"></td>
                                                        <td><input type="number" step="0.01" name="other_amt[]" class="form-control form-control-sm" value="{{ dyn.amount }}"></td>
                                                        <td><button type="button" class="btn btn-sm btn-danger py-0" onclick="this.closest('tr').remove()">x</button></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                            <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="addCostRow()">+ Add Row</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        {% else %}
                            <label class="form-label fw-bold">Amaun (RM)</label>
                            <input type="number" step="0.01" name="amaun" class="form-control" value="{{ record.amaun }}" required>
                        {% endif %}
                    </div>
                    
                    {% if record.sumber != 'Petros' %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nota / Keterangan</label>
                        <textarea name="nota" class="form-control" rows="3">{{ record.nota }}</textarea>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        <a href="javascript:history.back()" class="btn btn-secondary">Batal</a>
                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
<script>
    function addCostRow() {
        var table = document.getElementById("dynamicCostTable").getElementsByTagName('tbody')[0];
        var newRow = table.insertRow();
        
        var cell1 = newRow.insertCell(0);
        var cell2 = newRow.insertCell(1);
        var cell3 = newRow.insertCell(2);
        var cell4 = newRow.insertCell(3);
        
        cell1.innerHTML = `
            <select name="other_category[]" class="form-select form-select-sm">
                <option value="Expenses">Expenses</option>
                <option value="Services">Services</option>
                <option value="Staff Welfare">Staff Welfare</option>
                <option value="Documents Fees">Documents Fees</option>
                <option value="Other">Other</option>
            </select>`;
        cell2.innerHTML = '<input type="text" name="other_desc[]" class="form-control form-control-sm" placeholder="Keterangan...">';
        cell3.innerHTML = '<input type="number" step="0.01" name="other_amt[]" class="form-control form-control-sm" placeholder="0.00">';
        cell4.innerHTML = '<button type="button" class="btn btn-sm btn-danger py-0" onclick="this.closest(\'tr\').remove()">x</button>';
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</html>